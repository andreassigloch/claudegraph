{% extends "base.html" %}

{% block title %}Project Analyzer - {{ super() }}{% endblock %}

{% block extra_head %}
<style>
    .analyzer-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
    }

    .upload-zone {
        border: 3px dashed #dee2e6;
        border-radius: 15px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s ease;
        background: #f8f9fa;
        cursor: pointer;
        margin: 20px 0;
    }

    .upload-zone:hover, .upload-zone.dragover {
        border-color: #0d6efd;
        background: #e7f3ff;
        transform: translateY(-2px);
    }

    .upload-zone.active {
        border-color: #198754;
        background: #d1e7dd;
    }

    .file-list {
        max-height: 300px;
        overflow-y: auto;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
    }

    .file-item {
        display: flex;
        justify-content: between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
    }

    .file-item:last-child {
        border-bottom: none;
    }

    .analysis-options {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 25px;
        margin: 20px 0;
    }

    .option-group {
        margin: 20px 0;
    }

    .option-group label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        display: block;
    }

    .progress-section {
        display: none;
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 25px;
        margin: 20px 0;
    }

    .progress {
        height: 25px;
        border-radius: 15px;
        background-color: #e9ecef;
        overflow: hidden;
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .progress-bar {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        transition: width 0.6s ease;
        height: 100%;
        border-radius: 15px;
    }

    .progress-text {
        margin: 15px 0 5px 0;
        font-weight: 500;
        color: #495057;
    }

    .progress-details {
        font-size: 0.9em;
        color: #6c757d;
        margin: 5px 0;
    }

    .analysis-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .stat-card {
        background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);
        border: 1px solid #e1e8ff;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
    }

    .stat-card h5 {
        color: #0d6efd;
        font-size: 0.9em;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .stat-card .stat-number {
        font-size: 2.2em;
        font-weight: bold;
        color: #333;
        display: block;
    }

    .results-actions {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        text-align: center;
    }

    .log-section {
        background: #212529;
        color: #ffffff;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        line-height: 1.4;
    }

    .log-entry {
        margin: 5px 0;
        padding: 2px 0;
    }

    .log-entry.info { color: #17a2b8; }
    .log-entry.success { color: #28a745; }
    .log-entry.warning { color: #ffc107; }
    .log-entry.error { color: #dc3545; }

    .feature-highlight {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-left: 4px solid #2196f3;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
    }

    .feature-highlight h5 {
        color: #1976d2;
        margin-bottom: 10px;
    }

    .feature-list {
        list-style: none;
        padding: 0;
    }

    .feature-list li {
        padding: 8px 0;
        position: relative;
        padding-left: 25px;
    }

    .feature-list li::before {
        content: "âœ“";
        position: absolute;
        left: 0;
        color: #28a745;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="analyzer-card">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-3">
                        <i class="bi bi-cpu"></i> Project Analyzer
                    </h1>
                    <p class="lead mb-0">
                        Analyze Python projects to extract architectural patterns, dependencies, and information flows.
                        Transform complex code into clean, ontology-compliant graph representations.
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="h2 mb-0">
                        <i class="bi bi-diagram-3-fill opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Upload Section -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-cloud-upload"></i> Project Upload</h5>
            </div>
            <div class="card-body">
                <div class="upload-zone" id="uploadZone">
                    <div class="mb-3">
                        <i class="bi bi-folder2-open display-4 text-muted"></i>
                    </div>
                    <h4>Analyze Project Directory</h4>
                    <p class="text-muted">
                        Enter the full path to your Python project directory.
                        <br>The analyzer will use CLI filtering and analysis directly.
                    </p>
                    
                    <div class="input-group mb-3" style="max-width: 600px; margin: 0 auto;">
                        <input type="text" id="directoryPath" class="form-control" 
                               placeholder="/Users/andreas/Documents/Projekte/mlx" 
                               style="text-align: center;">
                        <button class="btn btn-success btn-lg" onclick="analyzeDirectoryPath()">
                            <i class="bi bi-play-circle"></i> Analyze Directory
                        </button>
                    </div>
                    
                    <div class="mt-3 mb-3">
                        <small class="text-muted">
                            Examples: /Users/name/my-project, /home/user/code/project, C:\Projects\MyApp
                        </small>
                    </div>
                    
                    <hr style="margin: 20px auto; width: 80%;">
                    
                    <!-- Fallback file upload -->
                    <div class="mt-3">
                        <p class="text-muted">
                            <strong>Alternative:</strong> Upload directory if path access isn't available
                        </p>
                        <input type="file" id="directoryInput" webkitdirectory multiple style="display: none;">
                        <button class="btn btn-outline-secondary" onclick="document.getElementById('directoryInput').click()">
                            <i class="bi bi-folder-plus"></i> Upload Directory Files
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- Analysis Options -->
        <div class="analysis-options" id="analysisOptions">
            <h5><i class="bi bi-gear"></i> Analysis Configuration</h5>
            
            <div class="option-group">
                <label for="llmProvider">LLM Provider:</label>
                <select id="llmProvider" class="form-select">
                    <option value="none">None (Pattern Matching Only) - Fastest</option>
                    <option value="local">Local LLM - Good Performance</option>
                    <option value="openai">OpenAI - High Quality</option>
                    <option value="anthropic">Anthropic - High Quality</option>
                </select>
                <small class="text-muted">
                    Pattern matching provides fast analysis. LLM providers offer enhanced classification.
                </small>
            </div>

            <div class="option-group">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enableFlowAnalysis" checked>
                    <label class="form-check-label" for="enableFlowAnalysis">
                        Enable Flow Analysis
                    </label>
                </div>
                <small class="text-muted">
                    Analyze function-to-function and external dependency flows.
                </small>
            </div>

            <div class="option-group">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enableDeadCodeDetection" checked>
                    <label class="form-check-label" for="enableDeadCodeDetection">
                        Detect Dead Code
                    </label>
                </div>
                <small class="text-muted">
                    Identify unused functions and isolated components.
                </small>
            </div>

            <div class="text-center mt-4">
                <button class="btn btn-success btn-lg" id="startAnalysisBtn" onclick="startAnalysis()">
                    <i class="bi bi-play-circle"></i> Start Analysis
                </button>
                <button class="btn btn-outline-secondary btn-lg ms-2" onclick="resetAnalyzer()">
                    <i class="bi bi-arrow-clockwise"></i> Reset
                </button>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="progress-section" id="progressSection">
            <h5><i class="bi bi-hourglass-split"></i> Analysis Progress</h5>
            
            <div class="progress-text" id="progressText">Initializing analysis...</div>
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="progress-details" id="progressDetails">Preparing for analysis...</div>

            <div class="analysis-stats" id="analysisStats" style="display: none;">
                <div class="stat-card">
                    <h5>Files Processed</h5>
                    <span class="stat-number" id="filesProcessed">0</span>
                </div>
                <div class="stat-card">
                    <h5>Functions Found</h5>
                    <span class="stat-number" id="functionsFound">0</span>
                </div>
                <div class="stat-card">
                    <h5>Actors Detected</h5>
                    <span class="stat-number" id="actorsDetected">0</span>
                </div>
                <div class="stat-card">
                    <h5>Flows Mapped</h5>
                    <span class="stat-number" id="flowsMapped">0</span>
                </div>
            </div>

            <div class="log-section" id="logSection">
                <div class="log-entry info">Analysis system initialized.</div>
                <div class="log-entry info">Ready to process files...</div>
            </div>
        </div>

        <!-- Results Actions -->
        <div class="results-actions" id="resultsActions" style="display: none;">
            <h5><i class="bi bi-check-circle text-success"></i> Analysis Complete!</h5>
            <p class="text-muted">Your project has been successfully analyzed. Choose what to do next:</p>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                <a href="/viewer" class="btn btn-primary btn-lg">
                    <i class="bi bi-diagram-3"></i> View Graph
                </a>
                <a href="/dead_code" class="btn btn-warning btn-lg">
                    <i class="bi bi-exclamation-triangle"></i> Dead Code Analysis
                </a>
                <button class="btn btn-outline-primary btn-lg" onclick="downloadResults()">
                    <i class="bi bi-download"></i> Download JSON
                </button>
                <a href="/review" class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-clipboard-check"></i> Review Results
                </a>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Features Info -->
        <div class="feature-highlight">
            <h5><i class="bi bi-lightbulb"></i> Analysis Features</h5>
            <ul class="feature-list">
                <li>Pattern-based actor detection (19 types)</li>
                <li>AST parsing for precise code analysis</li>
                <li>Bidirectional flow detection</li>
                <li>Neo4j-compatible graph output</li>
                <li>Dead code identification</li>
                <li>Multi-LLM provider support</li>
                <li>Real-time progress tracking</li>
                <li>Interactive visualization</li>
            </ul>
        </div>

        <!-- Analysis Types -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-layers"></i> Detected Patterns</h6>
            </div>
            <div class="card-body">
                <div class="small">
                    <div class="mb-2">
                        <span class="badge bg-info me-2">HTTP</span>
                        requests, urllib, httpx, aiohttp
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-warning me-2">DB</span>
                        sqlite3, psycopg2, pymongo, redis
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-success me-2">Files</span>
                        pathlib, os.path, shutil
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-primary me-2">Web</span>
                        Flask, FastAPI, Django
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-secondary me-2">Cloud</span>
                        AWS SDK, Google Cloud, Azure
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-graph-up"></i> Performance</h6>
            </div>
            <div class="card-body">
                <div class="small">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Speed:</span>
                        <span class="text-muted">0.01s / 1k LoC</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>Memory:</span>
                        <span class="text-muted">&lt;100MB typical</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>Tested up to:</span>
                        <span class="text-muted">25k LoC</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Accuracy:</span>
                        <span class="text-success">100% patterns</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let selectedFiles = [];
    let currentJobId = null;
    let isAnalyzing = false;
    let analysisResult = null;

    document.addEventListener('DOMContentLoaded', function() {
        // Show analysis options by default
        document.getElementById('analysisOptions').style.display = 'block';
        
        // Focus on directory path input
        document.getElementById('directoryPath').focus();
        
        // Allow Enter key to start analysis
        document.getElementById('directoryPath').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeDirectoryPath();
            }
        });
        
        // Add file upload fallback handler
        const directoryInput = document.getElementById('directoryInput');
        directoryInput.addEventListener('change', function(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                analyzeUploadedFiles(files);
            }
        });
    });


    function analyzeDirectoryPath() {
        const directoryPath = document.getElementById('directoryPath').value.trim();
        
        if (!directoryPath) {
            showToast('Please enter a directory path.', 'warning');
            return;
        }
        
        if (isAnalyzing) {
            showToast('Analysis already in progress.', 'warning');
            return;
        }
        
        isAnalyzing = true;
        
        // Get options
        const llmProvider = document.getElementById('llmProvider').value;
        
        // Show progress section
        document.getElementById('progressSection').style.display = 'block';
        document.getElementById('startAnalysisBtn').disabled = true;
        
        // Scroll to progress section
        document.getElementById('progressSection').scrollIntoView({ behavior: 'smooth' });

        addLogEntry(`Starting direct directory analysis: ${directoryPath}`, 'info');
        addLogEntry(`Configuration: LLM=${llmProvider}`, 'info');
        
        updateProgress(10, 'Initializing directory analysis...');
        
        // Call direct directory analysis endpoint
        fetch('/api/analyze-directory', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                directory_path: directoryPath,
                llm_provider: llmProvider
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            addLogEntry('Directory analysis completed successfully!', 'success');
            addLogEntry(`Found ${data.stats?.files_parsed || 0} files, ${data.stats?.functions_found || 0} functions`, 'info');
            
            updateProgress(100, 'Analysis completed!');
            
            // Store result and ask user what to do next
            analysisResult = data.result;
            sessionStorage.setItem('analysisResult', JSON.stringify(data.result));
            
            // Show results options instead of auto-redirect
            document.getElementById('resultsActions').style.display = 'block';
            document.getElementById('resultsActions').scrollIntoView({ behavior: 'smooth' });
            
            isAnalyzing = false;
        })
        .catch(error => {
            addLogEntry(`Failed directory analysis: ${error.message}`, 'error');
            resetAnalysisState();
        });
    }

    function analyzeUploadedFiles(files) {
        if (isAnalyzing) {
            showToast('Analysis already in progress.', 'warning');
            return;
        }
        
        // Basic filtering to avoid uploading thousands of files
        const pythonFiles = files.filter(file => {
            if (!file.name.endsWith('.py')) return false;
            const path = file.webkitRelativePath || file.name;
            // Exclude obvious virtual environment paths
            return !path.includes('/venv/') && !path.includes('/site-packages/') && 
                   !path.includes('/__pycache__/') && !path.includes('/.git/');
        });
        
        if (pythonFiles.length === 0) {
            showToast('No Python files found in uploaded directory.', 'warning');
            return;
        }
        
        if (pythonFiles.length > 500) {
            showToast(`Too many Python files (${pythonFiles.length}). Use directory path method instead.`, 'warning');
            return;
        }
        
        // Use the existing file upload API
        isAnalyzing = true;
        document.getElementById('progressSection').style.display = 'block';
        
        addLogEntry(`Starting file upload analysis with ${pythonFiles.length} files`, 'info');
        
        const formData = new FormData();
        pythonFiles.forEach(file => {
            formData.append('files', file);
        });
        formData.append('llm_provider', document.getElementById('llmProvider').value);
        
        fetch('/api/analyze', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            currentJobId = data.job_id;
            addLogEntry(`File upload analysis started: ${currentJobId}`, 'success');
            pollAnalysisProgress(currentJobId);
        })
        .catch(error => {
            addLogEntry(`Failed to start file upload analysis: ${error.message}`, 'error');
            resetAnalysisState();
        });
    }

    function startAnalysis() {
        if (selectedFiles.length === 0) {
            showToast('Please select a directory first.', 'warning');
            return;
        }

        if (isAnalyzing) {
            showToast('Analysis already in progress.', 'warning');
            return;
        }

        isAnalyzing = true;
        
        // Get options
        const llmProvider = document.getElementById('llmProvider').value;
        const enableFlowAnalysis = document.getElementById('enableFlowAnalysis').checked;
        const enableDeadCodeDetection = document.getElementById('enableDeadCodeDetection').checked;

        // Show progress section
        document.getElementById('progressSection').style.display = 'block';
        document.getElementById('startAnalysisBtn').disabled = true;
        
        // Scroll to progress section
        document.getElementById('progressSection').scrollIntoView({ behavior: 'smooth' });

        addLogEntry('Starting analysis...', 'info');
        addLogEntry(`Configuration: LLM=${llmProvider}, Flow=${enableFlowAnalysis}, DeadCode=${enableDeadCodeDetection}`, 'info');

        // Create FormData
        const formData = new FormData();
        selectedFiles.forEach(file => {
            formData.append('files', file);
        });
        formData.append('llm_provider', llmProvider);
        formData.append('enable_flow_analysis', enableFlowAnalysis);
        formData.append('enable_dead_code_detection', enableDeadCodeDetection);

        // Start analysis
        fetch('/api/analyze', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            currentJobId = data.job_id;
            addLogEntry(`Analysis job started: ${currentJobId}`, 'success');
            
            // Start polling for progress
            pollAnalysisProgress(currentJobId);
        })
        .catch(error => {
            addLogEntry(`Failed to start analysis: ${error.message}`, 'error');
            resetAnalysisState();
        });
    }

    function pollAnalysisProgress(jobId) {
        const pollInterval = setInterval(() => {
            fetch(`/api/status/${jobId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    updateProgress(data.progress, data.message);
                    
                    // Update stats based on real progress
                    if (data.progress > 20) {
                        document.getElementById('analysisStats').style.display = 'grid';
                        updateAnalysisStats(data.progress);
                    }
                    
                    if (data.status === 'completed') {
                        clearInterval(pollInterval);
                        addLogEntry('Analysis completed successfully!', 'success');
                        fetchAnalysisResult(jobId);
                    } else if (data.status === 'failed') {
                        clearInterval(pollInterval);
                        addLogEntry(`Analysis failed: ${data.error || 'Unknown error'}`, 'error');
                        resetAnalysisState();
                    }
                })
                .catch(error => {
                    clearInterval(pollInterval);
                    addLogEntry(`Error polling status: ${error.message}`, 'error');
                    resetAnalysisState();
                });
        }, 1000);
    }

    function fetchAnalysisResult(jobId) {
        fetch(`/api/result/${jobId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                analysisResult = data;
                addLogEntry('Analysis result retrieved successfully.', 'success');
                addLogEntry(`Found ${data.nodes?.length || 0} nodes and ${data.relationships?.length || 0} relationships.`, 'info');
                
                // Store result and ask user what to do next
                console.log('Storing analysis result in sessionStorage:', data);
                sessionStorage.setItem('analysisResult', JSON.stringify(data));
                
                addLogEntry('Analysis result stored.', 'success');
                
                // Show results options instead of auto-redirect
                document.getElementById('resultsActions').style.display = 'block';
                document.getElementById('resultsActions').scrollIntoView({ behavior: 'smooth' });
                
                isAnalyzing = false;
            })
            .catch(error => {
                addLogEntry(`Failed to fetch results: ${error.message}`, 'error');
                resetAnalysisState();
            });
    }

    function updateProgress(progress, message) {
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressDetails = document.getElementById('progressDetails');
        
        progressBar.style.width = `${progress}%`;
        progressText.textContent = message || 'Processing...';
        progressDetails.textContent = `${progress}% complete`;
        
        // Add log entry for major milestones
        if ([25, 50, 75, 90].includes(progress)) {
            addLogEntry(message, 'info');
        }
    }

    function updateAnalysisStats(progress) {
        // Placeholder stats - should be replaced with real data from API
        const filesTotal = selectedFiles.length;
        const filesProcessed = Math.floor((progress / 100) * filesTotal);
        
        document.getElementById('filesProcessed').textContent = filesProcessed;
        document.getElementById('functionsFound').textContent = 'â€”';
        document.getElementById('actorsDetected').textContent = 'â€”';
        document.getElementById('flowsMapped').textContent = 'â€”';
    }

    function addLogEntry(message, type = 'info') {
        const logSection = document.getElementById('logSection');
        const timestamp = new Date().toLocaleTimeString();
        
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry ${type}`;
        logEntry.textContent = `[${timestamp}] ${message}`;
        
        logSection.appendChild(logEntry);
        logSection.scrollTop = logSection.scrollHeight;
    }

    function resetAnalysisState() {
        isAnalyzing = false;
        currentJobId = null;
        document.getElementById('startAnalysisBtn').disabled = false;
        document.getElementById('progressSection').style.display = 'none';
        document.getElementById('analysisStats').style.display = 'none';
        document.getElementById('resultsActions').style.display = 'none';
    }

    function resetAnalyzer() {
        selectedFiles = [];
        analysisResult = null;
        
        document.getElementById('fileList').style.display = 'none';
        document.getElementById('analysisOptions').style.display = 'none';
        document.getElementById('uploadZone').classList.remove('active');
        document.getElementById('directoryInput').value = '';
        
        resetAnalysisState();
        
        // Clear log
        const logSection = document.getElementById('logSection');
        logSection.innerHTML = `
            <div class="log-entry info">Analysis system initialized.</div>
            <div class="log-entry info">Ready to process files...</div>
        `;
        
        showToast('Analyzer reset successfully.', 'info');
    }

    function downloadResults() {
        if (!analysisResult) {
            showToast('No analysis results available.', 'warning');
            return;
        }

        const dataStr = JSON.stringify(analysisResult, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `analysis_result_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        addLogEntry('Analysis results downloaded.', 'success');
    }
</script>
{% endblock %}