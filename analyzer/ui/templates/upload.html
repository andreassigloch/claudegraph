{% extends "base.html" %}

{% block title %}Upload Project - {{ super() }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-cloud-upload"></i> Upload Project</h1>
            <div>
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-speedometer2"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Single Upload Option -->
<div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-folder-plus"></i> Select Files or Folder
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Select Python files or an entire folder containing your project.
                </p>
                
                <form id="upload-form">
                    <div class="mb-4">
                        <label for="project-files" class="form-label">Choose Files or Folder</label>
                        <input type="file" 
                               class="form-control" 
                               id="project-files" 
                               accept=".py"
                               multiple
                               webkitdirectory="false">
                        <div class="form-text">
                            Select individual .py files or click "Choose Folder" below to select an entire directory
                        </div>
                    </div>
                    
                    <div class="mb-4 text-center">
                        <button type="button" class="btn btn-outline-primary" onclick="selectFolder()">
                            <i class="bi bi-folder"></i> Choose Folder Instead
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-2" onclick="selectFiles()">
                            <i class="bi bi-file-code"></i> Choose Files Instead
                        </button>
                    </div>
                    
                    <!-- Selected Items Display -->
                    <div id="selected-items" class="mb-4 d-none">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">Selected:</h6>
                            <span id="item-count-badge" class="badge bg-primary">0</span>
                        </div>
                        <div id="items-list" class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="project-name" class="form-label">Project Name</label>
                        <input type="text" 
                               class="form-control" 
                               id="project-name" 
                               placeholder="My Python Project">
                        <div class="form-text">
                            Enter a name for this analysis (will be auto-generated if left empty)
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-play-circle"></i> Start Analysis
                        </button>
                    </div>
                </form>
                
                <!-- Load Sample Project -->
                <div class="text-center mt-4 pt-4 border-top">
                    <p class="text-muted mb-2">Or try with sample data:</p>
                    <button class="btn btn-outline-info" onclick="loadSampleProject('sample')">
                        <i class="bi bi-star"></i> Load Sample Project
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let isSelecting = 'files'; // 'files' or 'folder'

// Toggle between file and folder selection
function selectFolder() {
    const fileInput = document.getElementById('project-files');
    fileInput.setAttribute('webkitdirectory', '');
    fileInput.removeAttribute('multiple');
    fileInput.accept = '';
    isSelecting = 'folder';
    
    // Update UI
    document.querySelector('.form-text').textContent = 'Select a folder containing your Python project';
    showToast('Switched to folder selection mode', 'info');
}

function selectFiles() {
    const fileInput = document.getElementById('project-files');
    fileInput.removeAttribute('webkitdirectory');
    fileInput.setAttribute('multiple', '');
    fileInput.accept = '.py';
    isSelecting = 'files';
    
    // Update UI
    document.querySelector('.form-text').textContent = 'Select individual .py files or click "Choose Folder" below to select an entire directory';
    showToast('Switched to file selection mode', 'info');
}

// Handle file/folder selection
document.getElementById('project-files').addEventListener('change', function() {
    const files = this.files;
    const selectedItemsDiv = document.getElementById('selected-items');
    const itemsListDiv = document.getElementById('items-list');
    const itemCountBadge = document.getElementById('item-count-badge');
    const projectNameInput = document.getElementById('project-name');
    
    if (files.length > 0) {
        selectedItemsDiv.classList.remove('d-none');
        
        if (isSelecting === 'folder') {
            // Folder selection
            const firstFile = files[0];
            const pathParts = firstFile.webkitRelativePath.split('/');
            const folderName = pathParts[0];
            const pythonFiles = Array.from(files).filter(file => file.name.endsWith('.py'));
            
            itemCountBadge.textContent = `${pythonFiles.length} Python files`;
            itemsListDiv.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-folder text-primary me-2"></i>
                    <strong>${folderName}</strong>
                    <span class="ms-auto text-muted">${files.length} total files</span>
                </div>
                <div class="d-flex align-items-center">
                    <i class="bi bi-file-code text-success me-2"></i>
                    <span>Python files found</span>
                    <span class="ms-auto text-muted">${pythonFiles.length} files</span>
                </div>
            `;
            
            // Auto-fill project name
            if (!projectNameInput.value) {
                projectNameInput.value = folderName.charAt(0).toUpperCase() + folderName.slice(1);
            }
            
            showToast(`Folder selected: ${pythonFiles.length} Python files found`, 'success');
        } else {
            // File selection
            const pythonFiles = Array.from(files).filter(file => file.name.endsWith('.py'));
            
            if (pythonFiles.length === 0) {
                showToast('No Python files selected. Please select .py files.', 'error');
                selectedItemsDiv.classList.add('d-none');
                return;
            }
            
            itemCountBadge.textContent = `${pythonFiles.length} Python files`;
            itemsListDiv.innerHTML = pythonFiles.map(file => {
                const sizeKB = (file.size / 1024).toFixed(1);
                return `
                    <div class="d-flex align-items-center mb-1">
                        <i class="bi bi-file-code text-primary me-2"></i>
                        <span class="flex-grow-1">${file.name}</span>
                        <span class="text-muted">${sizeKB} KB</span>
                    </div>
                `;
            }).join('');
            
            // Auto-fill project name
            if (!projectNameInput.value) {
                if (pythonFiles.length === 1) {
                    const baseName = pythonFiles[0].name.replace('.py', '');
                    projectNameInput.value = baseName.charAt(0).toUpperCase() + baseName.slice(1);
                } else {
                    projectNameInput.value = `${pythonFiles.length} Python Files`;
                }
            }
            
            showToast(`${pythonFiles.length} Python file(s) selected`, 'success');
        }
    } else {
        selectedItemsDiv.classList.add('d-none');
        itemsListDiv.innerHTML = '';
        itemCountBadge.textContent = '0';
    }
});

// Form submission handler
document.getElementById('upload-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('project-files');
    const files = fileInput.files;
    const projectName = document.getElementById('project-name').value || 'Python Analysis';
    
    if (!files || files.length === 0) {
        showToast('Please select files or a folder first', 'error');
        return;
    }
    
    showLoading('Processing selection...');
    
    try {
        let analysisData;
        
        if (isSelecting === 'folder') {
            // Process folder selection
            const pythonFiles = Array.from(files)
                .filter(file => file.name.endsWith('.py'))
                .map(file => file.webkitRelativePath);
            
            if (pythonFiles.length === 0) {
                showToast('No Python files found in selected folder', 'error');
                return;
            }
            
            analysisData = {
                type: 'directory_files',
                path: pythonFiles[0].split('/')[0],
                name: projectName,
                files: pythonFiles,
                file_count: pythonFiles.length
            };
        } else {
            // Process file selection
            const pythonFiles = Array.from(files).filter(file => file.name.endsWith('.py'));
            
            if (pythonFiles.length === 0) {
                showToast('Please select at least one Python file', 'error');
                return;
            }
            
            const fileData = pythonFiles.map(file => ({
                name: file.name,
                size: file.size,
                type: file.type || 'text/x-python'
            }));
            
            analysisData = {
                type: 'files',
                file_count: pythonFiles.length,
                name: projectName,
                files: fileData
            };
        }
        
        // Simulate processing
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        const result = await apiCall('/api/project/load', {
            method: 'POST',
            body: JSON.stringify(analysisData)
        });
        
        if (result.success) {
            showToast(`Successfully loaded: ${projectName}`, 'success');
            setTimeout(() => {
                window.location.href = '/';
            }, 1500);
        } else {
            showToast('Failed to load project: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Error processing selection:', error);
        showToast('Error processing selection: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
});

// Load sample project
async function loadSampleProject(type) {
    showLoading('Loading sample project...');
    
    try {
        const result = await apiCall('/api/project/load', {
            method: 'POST',
            body: JSON.stringify({
                type: 'sample',
                sample_type: type
            })
        });
        
        if (result.success) {
            showToast('Sample project loaded successfully', 'success');
            setTimeout(() => {
                window.location.href = '/';
            }, 1500);
        } else {
            showToast('Failed to load sample: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Error loading sample:', error);
        showToast('Error loading sample: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}
</script>
{% endblock %}